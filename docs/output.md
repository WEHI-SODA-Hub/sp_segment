# WEHI-SODA-Hub/spatialproteomics: Output

## Introduction

This document describes the output produced by the pipeline.

The directories listed below will be created in the results directory after the pipeline has finished. All paths are relative to the top-level results directory.

Depending on the mode(s) run, the pipeline can produce background subtracted TIFFs, TIFF masks containing nuclear and whole-cell segmentations, and resolved whole-cell and nuclear segmentations in GeoJSON format.

## Pipeline overview

The pipeline is built using [Nextflow](https://www.nextflow.io/) and processes data using the following steps:

- Background subtraction (COMET only) - generates a background subtracted TIFF
- Segmentation via Cellpose (COMET) or Mesmer (COMET/MIBI) for nuclear and whole
  cell
- Cell measurement
  - generates a GeoJSON file with consolidated whole-cell/nuclear segmentations
  - calculates cell compartment measurements and channel intensities
- [Pipeline information](#pipeline-information) - Report metrics generated during the workflow execution

### Pipeline outputs

<details markdown="1">
<summary>Output files</summary>

#### Background subtraction (COMET only)

- `extractmarkers/sample.csv` -- marker names, background per channel and
  exposure time
- `backsub/sample.tiff` -- bakground subtracted tiff image.

#### Cellpose segmentation

- `sopa/sample.zarr` -- SpatialData converted image containing segmentations.
- `parquettotiffwholecell/sample_whole-cell.tiff` -- tiff label masks from cellpose segmentation for
  whole cell segmentation.
- `parquettotiffnuclear/sample_nuclear.tiff` -- tiff label masks from cellpose segmentation for
  nuclear segmentation.

#### Mesmer segmentation

- `mesmerwc/sample_whole-cell.tiff` -- tiff label masks for cellpose whole-cell segmentation.
- `mesmernuc/sample_nuclear.tiff` -- tiff label masks for cellpose nuclear segmentation.

#### Cell measurement

- `cellmeasurement/sample.geojson` -- resolved whole-cell and nuclear
  segmentations, optionally containing measurements and intensity values per
  cell, compatible with QuPath.

#### Segmentation report

- `segmentationreport/sample/sample.html` -- html file for visualising report.

#### Data provenance

- `pipeline_info/`
  - Reports generated by Nextflow: `execution_report.html`, `execution_timeline.html`, `execution_trace.txt` and `pipeline_dag.dot`/`pipeline_dag.svg`.
  - Reports generated by the pipeline: `pipeline_report.html`, `pipeline_report.txt` and `software_versions.yml`. The `pipeline_report*` files will only be present if the `--email` / `--email_on_fail` parameter's are used when running the pipeline.
  - Reformatted samplesheet files used as input to the pipeline: `samplesheet.valid.csv`.
  - Parameters used by the pipeline run: `params.json`.

</details>

[Nextflow](https://www.nextflow.io/docs/latest/tracing.html) provides excellent functionality for generating various reports relevant to the running and execution of the pipeline. This will allow you to troubleshoot errors with the running of the pipeline, and also provide you with other information such as launch commands, run times and resource usage.
